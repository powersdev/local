#!/usr/bin/env hush

import getpass, os
from subprocess import Popen, PIPE

# Globals 
repo = std.env('repo')
vip = std.contains(repo, "wpcomvip")
multisite = std.contains(std.env("multisite"), "yes")


# Download WordPress
function fetch_wordpress()
    {
        curl -O https://wordpress.org/latest.tar.gz;
        tar -xvf latest.tar.gz;
        rm latest.tar.gz;

    }
end


# Clone the repo
function fetch_repo()
    { git clone $repo theme }
    
    if vip then
        { rsync -avh theme/ /app/wordpress/wp-content }
    else
        { rsync -avh theme/ /app/wordpress }
    end

    { rm -rf theme }
end


# Run the site installation script
function install_wordpress()
    { /app/bin/core_install }
end


# Cloning VIP Go mu-plugins
function fetch_vip_muplugins()
{
    git clone git@github.com:Automattic/vip-go-mu-plugins-built.git;
    rsync -avh ./vip-go-mu-plugins-built/ /app/wordpress/wp-content/mu-plugins;
    rm -rf vip-go-mu-plugins-built:
} 
end


# Activate theme and install dependencies
function install_theme_deps()
    os.system('/app/bin/theme_install')
end

fetch_wordpress()
fetch_repo()
install_wordpress()

if vip then
    fetch_vip_muplugins()
end

install_theme_deps()